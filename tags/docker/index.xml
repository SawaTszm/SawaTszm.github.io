<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
    <channel>
        <title>Docker on sawa.md</title>
        <link>https://SawaTszm.github.io/tags/docker/</link>
        <description>Recent content in Docker on sawa.md</description>
        <generator>Hugo -- gohugo.io</generator>
        <language>en-us</language>
        <lastBuildDate>Fri, 19 Feb 2021 12:01:46 +0900</lastBuildDate><atom:link href="https://SawaTszm.github.io/tags/docker/index.xml" rel="self" type="application/rss+xml" /><item>
        <title>【Docker】【nginx】docker-compose上のnginxをhttps対応する(開発環境編)</title>
        <link>https://SawaTszm.github.io/p/dockernginxdocker-compose%E4%B8%8A%E3%81%AEnginx%E3%82%92https%E5%AF%BE%E5%BF%9C%E3%81%99%E3%82%8B%E9%96%8B%E7%99%BA%E7%92%B0%E5%A2%83%E7%B7%A8/</link>
        <pubDate>Fri, 19 Feb 2021 12:01:46 +0900</pubDate>
        
        <guid>https://SawaTszm.github.io/p/dockernginxdocker-compose%E4%B8%8A%E3%81%AEnginx%E3%82%92https%E5%AF%BE%E5%BF%9C%E3%81%99%E3%82%8B%E9%96%8B%E7%99%BA%E7%92%B0%E5%A2%83%E7%B7%A8/</guid>
        <description>&lt;h2 id=&#34;目的&#34;&gt;目的&lt;/h2&gt;
&lt;p&gt;docker-composeで立てたnginxをhttps対応にする。&lt;br&gt;
あくまでも開発環境用なのでオレオレ証明書です。&lt;/p&gt;
&lt;h2 id=&#34;手順&#34;&gt;手順&lt;/h2&gt;
&lt;h3 id=&#34;自己署名証明書をサクッと作成する&#34;&gt;自己署名証明書をサクッと作成する&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;❯ openssl req -x509 -nodes -new -keyout server.key -out server.crt -days &lt;span class=&#34;m&#34;&gt;365&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;docker-composeの更新&#34;&gt;docker-composeの更新&lt;/h3&gt;
&lt;p&gt;443ポートを使用するように変更。&lt;br&gt;
また、作成した証明書も読み込めるように&lt;code&gt;volumes&lt;/code&gt;も更新。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-docker&#34; data-lang=&#34;docker&#34;&gt;version: &lt;span class=&#34;s2&#34;&gt;&amp;#34;3.5&amp;#34;&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;&lt;/span&gt;services:&lt;span class=&#34;err&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;&lt;/span&gt;    web:&lt;span class=&#34;err&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;&lt;/span&gt;        build: ./docker/nginx&lt;span class=&#34;err&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;&lt;/span&gt;        restart: always&lt;span class=&#34;err&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;&lt;/span&gt;        ports:&lt;span class=&#34;err&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;&lt;/span&gt;            - 443:443  &lt;span class=&#34;c1&#34;&gt;# 変更&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;&lt;/span&gt;        depends_on:&lt;span class=&#34;err&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;&lt;/span&gt;            - app&lt;span class=&#34;err&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;&lt;/span&gt;        volumes:&lt;span class=&#34;err&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;&lt;/span&gt;            - ./:/var/www/html&lt;span class=&#34;err&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;&lt;/span&gt;            - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf&lt;span class=&#34;err&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;&lt;/span&gt;            - ./docker/nginx/server.crt:/etc/nginx/server.crt  &lt;span class=&#34;c1&#34;&gt;# 追加&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;&lt;/span&gt;            - ./docker/nginx/server.key:/etc/nginx/server.key  &lt;span class=&#34;c1&#34;&gt;# 追加&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;&lt;/span&gt;        links:&lt;span class=&#34;err&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;&lt;/span&gt;            - app&lt;span class=&#34;err&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;&lt;/span&gt;        networks:&lt;span class=&#34;err&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;&lt;/span&gt;            - default&lt;span class=&#34;err&#34;&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;defaultconfの更新&#34;&gt;default.confの更新&lt;/h3&gt;
&lt;p&gt;ポートを443に変更し、証明書の情報を追加します。&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code class=&#34;language-conf&#34; data-lang=&#34;conf&#34;&gt;server {
    listen       443;
    ssl on;
    ssl_certificate /etc/nginx/server.crt;
    ssl_certificate_key /etc/nginx/server.key;
    index index.php index.html;
    server_name php-docker.local;
    error_log  /var/log/nginx/error.log;
    access_log /var/log/nginx/access.log;
    root /var/www/html/laravel/public;

    location / {
     try_files $uri $uri/ @laravel;
    }
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;立ち上げ&#34;&gt;立ち上げ&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;❯ docker-compose down &lt;span class=&#34;o&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; docker-compose up -d
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;❯ docker-compose ps
       Name                      Command              State                           Ports
--------------------------------------------------------------------------------------------------------------------

web_1                 nginx -g daemon off&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;            Up      0.0.0.0:443-&amp;gt;443/tcp
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;オレオレ証明書なので接続時に警告が出ますが、ひとまずこれでhttpsでの接続が可能になりました。&lt;/p&gt;
&lt;h2 id=&#34;補足laravel-admin対応&#34;&gt;【補足】laravel-admin対応&lt;/h2&gt;
&lt;h3 id=&#34;環境変数の更新&#34;&gt;環境変数の更新&lt;/h3&gt;
&lt;p&gt;&lt;code&gt;.env&lt;/code&gt;の&lt;code&gt;APP_URL&lt;/code&gt;を更新する。&lt;br&gt;
&lt;code&gt;APP_URL=https://~~~&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;ちなみに実際の作業時、ここをちゃんとhttpsにはしてたんですが、お試しデプロイ時にlocalhostにしたままにしてしまって遷移先が全部つながらずフフ……となるなどしました。&lt;/p&gt;
&lt;h3 id=&#34;設定ファイルの更新&#34;&gt;設定ファイルの更新&lt;/h3&gt;
&lt;p&gt;larave-adminの遷移先URLもhttpsにするため、&lt;code&gt;confit/admin.php&lt;/code&gt;も修正。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-php&#34; data-lang=&#34;php&#34;&gt;    &lt;span class=&#34;s1&#34;&gt;&amp;#39;https&amp;#39;&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;env&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;ADMIN_HTTPS&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;TRUE&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;参考にさせていただいたもの&#34;&gt;参考にさせていただいたもの&lt;/h2&gt;
&lt;p&gt;&lt;a class=&#34;link&#34; href=&#34;https://qiita.com/ll_kuma_ll/items/13c962a6a74874af39c6&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;オレだよオレオレ認証局で証明書つくる - Qiita&lt;/a&gt;&lt;br&gt;
&lt;a class=&#34;link&#34; href=&#34;https://tomcky.hatenadiary.jp/entry/2018/01/28/193719&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;Nginx on DockerでHTTPS接続できるローカルサーバーを用意する - Tomcky’s blog&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;これも大事&lt;br&gt;
&lt;a class=&#34;link&#34; href=&#34;https://qiita.com/Sheile/items/dc91128e8918fc823562&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;オレオレ証明書を使いたがる人を例を用いて説得する - Qiita&lt;/a&gt;&lt;/p&gt;</description>
        </item>
        
    </channel>
</rss>
